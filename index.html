<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Re-Ropero | Recicla y Reutiliza Textiles en Temuco</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuraci√≥n personalizada de la paleta de colores de Re-Ropero -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Colores principales de la paleta
                        'reropero-dark-green': '#1e5631', // Verde Oscuro (para texto principal y acentos)
                        'reropero-soft-green': '#a7d9b5', // Color de Acento o toques
                        'reropero-light-gray': '#e7e8eb', // Gris Claro (Fondo principal de la app)
                        
                        // Colores espec√≠ficos para el Footer
                        'reropero-footer-text': '#e7e8eb', // Texto del Footer (Gris Claro)
                        'reropero-footer-bg': '#1e5631', // Fondo del Footer (Verde Oscuro)
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos base para las tarjetas accesibles */
        .accessible-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .accessible-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(30, 86, 49, 0.1), 0 4px 6px -4px rgba(30, 86, 49, 0.1);
        }
        /* Estilo para los iconos SVG */
        .svg-icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            stroke: currentColor; 
        }
        /* Clase para el contenedor de cada "p√°gina" */
        .page-view {
            min-height: calc(100vh - 4rem - 110px); /* Altura de la vista menos nav y footer */
            padding-top: 5rem;
            padding-bottom: 5rem;
        }
        /* Estilo para la imagen del encabezado */
        #hero-image-container {
            width: 100%;
            height: 400px;
            overflow: hidden;
            border-radius: 1rem;
            margin-top: 2rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        #hero-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* Estilo para el bot√≥n activo de las pesta√±as */
        .tab-button.active {
            border-bottom: 3px solid #1e5631;
            color: #1e5631;
            font-weight: bold;
        }
    </style>
</head>

<!-- Body con fondo gris claro y texto verde oscuro -->
<body class="bg-reropero-light-gray text-reropero-dark-green font-sans">

    <!-- Barra de Navegaci√≥n Fija -->
    <nav class="sticky top-0 z-50 bg-white shadow-lg border-b-4 border-reropero-dark-green">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="#" onclick="showSection('proposito')" class="flex-shrink-0 text-2xl font-bold text-reropero-dark-green">
                    Re-Ropero
                </a>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#" id="nav-proposito" onclick="showSection('proposito')" class="nav-link px-3 py-2 rounded-md text-base font-medium transition-colors">Inicio</a>
                        <a href="#" id="nav-mapa" onclick="showSection('mapa')" class="nav-link hover:text-green-700 px-3 py-2 rounded-md text-base font-medium transition-colors">Mapa</a>
                        <!-- NUEVO ENLACE A HACER UNA DONACI√ìN -->
                        <a href="#" id="nav-donacion" onclick="showSection('donacion')" class="nav-link hover:text-green-700 px-3 py-2 rounded-md text-base font-medium transition-colors">Donaci√≥n</a>
                        <a href="#" id="nav-impacto" onclick="showSection('impacto')" class="nav-link hover:text-green-700 px-3 py-2 rounded-md text-base font-medium transition-colors">Impacto</a>
                        <!-- ENLACE A SABER M√ÅS (AHORA CONTIENE LA FUNCI√ìN LLM) -->
                        <a href="#" id="nav-saber-mas" onclick="showSection('saber-mas')" class="nav-link hover:text-green-700 px-3 py-2 rounded-md text-base font-medium transition-colors">Saber M√°s</a>
                        <!-- Mi Perfil: Oculto por defecto, visible solo si hay sesi√≥n iniciada -->
                        <a href="#" id="nav-perfil" class="hidden nav-link hover:text-green-700 px-3 py-2 rounded-md text-base font-medium transition-colors" onclick="showSection('perfil')">Mi Perfil</a>
                        
                        <!-- Ayuda (Se mantiene como ayuda, el bot√≥n de sesi√≥n es din√°mico) -->
                        <a href="#" id="nav-ayuda" onclick="showSection('ayuda')" class="nav-link hover:text-green-700 px-3 py-2 rounded-md text-base font-medium transition-colors">Ayuda</a>

                        <!-- Bot√≥n de Autenticaci√≥n Din√°mico (Iniciar Sesi√≥n / Cerrar Sesi√≥n) -->
                        <a href="#" id="nav-auth" class="nav-link bg-reropero-dark-green text-white px-3 py-2 rounded-md text-base font-medium transition-colors hover:bg-green-700">Iniciar Sesi√≥n</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Contenedor para mostrar mensajes (en lugar de alert()) -->
    <div id="message-box" class="fixed top-20 right-4 p-4 rounded-lg shadow-xl z-50 transition-transform transform translate-x-full">
        <p id="message-text" class="font-semibold"></p>
    </div>

    <!-- Display del User ID para seguimiento (MANDATORIO) -->
    <div id="user-id-display" class="fixed top-16 right-4 p-1 text-xs bg-gray-200 text-gray-700 rounded-b-lg shadow-md hidden z-40">
        <!-- Rellenado por JS al iniciar sesi√≥n -->
    </div>

    <!-- 1. Contenido de la P√°gina de Inicio (Fondo Gris Claro) -->
    <section id="proposito" class="page-view bg-reropero-light-gray">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
             <!-- Texto en verde oscuro (heredado del body) -->
            <p class="text-3xl font-semibold mb-4">
                Bienvenido/a a Re-Ropero
            </p>
            <h1 class="text-6xl sm:text-7xl font-extrabold leading-tight mb-4">
                <!-- T√≠tulo Corregido -->
                ¬°Dale una nueva vida a tu ropa!
            </h1>
            <!-- Texto principal ahora en verde oscuro (heredado del body) -->
            <p class="mt-4 text-2xl max-w-4xl mx-auto">
                Re-Ropero conecta a las personas con puntos de donaci√≥n y reciclaje textil cercanos. Transforma tus prendas en nuevas oportunidades y gana beneficios.
            </p>
            
            <!-- Imagen de H√©roe (Simulaci√≥n) -->
            <div id="hero-image-container">
                <img src="https://placehold.co/1200x400/1e5631/ffffff?text=Imagen+Principal+de+Ropa+y+Reciclaje" alt="Ropa doblada lista para donar o reciclar, con el logo de Re-Ropero">
            </div>

            <div class="mt-10 flex justify-center space-x-4">
                <a href="#" onclick="showSection('donacion')" class="px-8 py-4 text-xl font-bold rounded-xl text-white bg-reropero-dark-green shadow-xl transition-all hover:bg-green-800 transform hover:scale-105">
                    Comenzar a Donar Ahora
                </a>
            </div>

            <!-- Dato de Impacto que capta la atenci√≥n -->
            <div class="mt-16 p-6 bg-white rounded-xl shadow-2xl max-w-2xl mx-auto border-l-8 border-reropero-dark-green">
                <h2 class="text-xl font-bold text-reropero-dark-green mb-2">¬øSab√≠as que...?</h2>
                <!-- T√≠tulos m√°s grandes se mantienen en gris oscuro o negro para alto contraste -->
                <p class="text-2xl font-extrabold text-gray-900">
                    En Chile se generan m√°s de 572 toneladas de residuos textiles al a√±o.
                </p>
                <!-- Texto en verde oscuro (heredado del body) -->
                <p class="text-lg mt-2">T√∫ puedes ser parte de este cambio.</p>
            </div>

            <!-- C√≥mo Funciona (Flujo de la App) - SECCI√ìN ACTUALIZADA -->
            <div class="mt-20">
                <h2 class="text-4xl sm:text-5xl font-extrabold text-reropero-dark-green text-center mb-16">
                    ¬øC√≥mo funciona Re-Ropero?
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                    <!-- Paso 1: Encuentra (Fondo Blanco para contraste) -->
                    <div class="accessible-card p-6 rounded-xl bg-white">
                        <div class="mx-auto h-24 w-24 flex items-center justify-center bg-reropero-dark-green/20 rounded-full mb-4 text-6xl">
                            üìç
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900">1. Localiza</h3>
                        <!-- Texto en verde oscuro (heredado del body) -->
                        <p class="mt-2 text-lg">
                            Usa nuestro mapa interactivo para encontrar puntos de donaci√≥n o reciclaje cercanos.
                        </p>
                    </div>
                    <!-- Paso 2: Deposita -->
                    <div class="accessible-card p-6 rounded-xl bg-white">
                        <div class="mx-auto h-24 w-24 flex items-center justify-center bg-reropero-dark-green/20 rounded-full mb-4 text-6xl">
                            ‚ôªÔ∏è
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900">2. Prepara y Escanea</h3>
                        <!-- Texto en verde oscuro (heredado del body) -->
                        <p class="mt-2 text-lg">
                            Prepara los productos o prendas que quieras donar o reciclar y, al llegar al punto seleccionado, escanea el c√≥digo QR para completar la entrega.

                        </p>
                    </div>
                    <!-- Paso 3: Gana -->
                    <div class="accessible-card p-6 rounded-xl bg-white">
                        <div class="mx-auto h-24 w-24 flex items-center justify-center bg-reropero-dark-green/20 rounded-full mb-4 text-6xl">
                            ü™ô
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900">3. Obt√©n recompensas</h3>
                        <!-- Texto en verde oscuro (heredado del body) -->
                        <p class="mt-2 text-lg">
                            Acumula puntos por cada entrega y canj√©alos por descuentos o beneficios locales.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- 2. Contenido de la Secci√≥n Mapa (Fondo Gris Claro) -->
    <section id="mapa" class="page-view hidden bg-reropero-light-gray">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-4xl sm:text-5xl font-extrabold text-reropero-dark-green text-center mb-12">
                Encuentra tu punto de reciclaje
            </h2>
            <!-- Texto principal ahora en verde oscuro (heredado del body) -->
            <p class="text-center text-lg max-w-3xl mx-auto mb-10">
                Visualiza en tiempo real todos los lugares cercanos donde puedes donar o reciclar tu ropa. 
            </p>

            <div class="bg-white p-6 rounded-xl shadow-2xl border-2 border-reropero-soft-green">
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- Columna de Filtros y Fichas (Simulaci√≥n) -->
                    <div class="md:w-1/3 p-4 border-r border-gray-200">
                        
                        <!-- Campo de B√∫squeda -->
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-reropero-dark-green mb-2">Buscar por ciudad o direcci√≥n</h3>
                            <div class="flex">
                                <input type="text" placeholder="Ej: Temuco, Av. Alemania" class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-reropero-dark-green">
                                <button class="p-2 bg-reropero-dark-green text-white rounded-r-lg hover:bg-green-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="svg-icon h-6 w-6" viewBox="0 0 24 24"><path d="M19 19l-6-6m-7 0a7 7 0 1114 0 7 7 0 01-14 0z"/></svg>
                                </button>
                            </div>
                        </div>

                        <h3 class="text-xl font-bold text-reropero-dark-green mt-6 mb-4">Filtros R√°pidos</h3>
                        <div class="space-y-3">
                            <!-- Filtro 1: Donaci√≥n -->
                            <label class="block">
                                <input type="checkbox" checked class="rounded text-reropero-dark-green focus:ring-reropero-dark-green">
                                <span class="ml-2">Donaci√≥n</span>
                            </label>
                            <!-- Filtro 2: Reciclaje (TEXTO SIMPLIFICADO) -->
                            <label class="block">
                                <input type="checkbox" class="rounded text-reropero-dark-green focus:ring-reropero-dark-green">
                                <span class="ml-2">Reciclaje</span>
                            </label>
                        </div>
                        
                        <h3 class="text-xl font-bold text-reropero-dark-green mt-6 mb-4">Puntos Cercanos</h3>
                        <!-- Simulaci√≥n de Ficha de Punto de Reciclaje. -->
                        <div class="accessible-card border p-4 rounded-lg bg-gray-100 hover:bg-gray-200 cursor-pointer">
                            <!-- T√≠tulo revertido -->
                            <h4 class="font-bold text-gray-900 text-lg">
                                Punto de Reciclaje / Tienda Ecol√≥gica
                            </h4>
                            <!-- Direcci√≥n y Distancia (Posici√≥n original) -->
                            <p class="text-sm">
                                üìç Av. Alemania 1050, Temuco (1.2 km)
                            </p>
                            <!-- Calificaci√≥n y rese√±as (Posici√≥n revertida) -->
                            <span class="flex items-center text-sm text-gray-600 mt-1 mb-2">
                                <span class="text-yellow-500 mr-1">‚òÖ4,5</span> (20 rese√±as)
                            </span>
                            <!-- Horario -->
                            <p class="text-xs text-green-700 font-semibold mt-1">
                                üïì Lunes a viernes 9:00 ‚Äì 18:00 hrs.
                            </p>
                            <!-- Materiales Aceptados -->
                            <p class="text-xs text-reropero-dark-green font-semibold mt-1">
                                Acepta: ropa limpia, calzado, telas.
                            </p>
                            <div class="flex space-x-4 mt-3 text-sm">
                                <!-- C√≥mo Llegar - √çCONO REVERTIDO A PIN DE MAPA -->
                                <button class="flex items-center text-reropero-dark-green hover:underline">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="svg-icon h-4 w-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                    </svg>
                                    C√≥mo Llegar
                                </button>
                                <!-- Llamar - √çcono de tel√©fono -->
                                <button class="flex items-center text-reropero-dark-green hover:underline">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="svg-icon h-4 w-4 mr-1" viewBox="0 0 24 24"><path d="M22 16.9v3c0 .8-.7 1.6-1.5 1.6A19.9 19.9 0 0 1 2 4.4C2 3.6 2.7 3 3.5 3h3a1 1 0 0 1 1 1.1l-1 5a1 1 0 0 1-.5.7l-2 1.4a15.8 15.8 0 0 0 7.4 7.4l1.4-2c.2-.3.6-.5.9-.5h5c.8 0 1.5.7 1.5 1.5z"/></svg> Llamar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Columna de Mapa (IMAGEN PROPORCIONADA POR EL USUARIO) -->
                    <div class="md:w-2/3 h-96 rounded-lg overflow-hidden bg-gray-100 flex items-center justify-center">
                        <!-- La imagen est√° con 'object-contain' para asegurar que se vea completa -->
                        <img src="uploaded:image_bc6bc7.png-9ef2a8db-7869-481c-aed5-10d4b9c7c1cd" 
                             alt="Mapa de Temuco con puntos de reciclaje marcados" 
                             class="w-full h-full object-contain">
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 3. Contenido de HACER UNA DONACI√ìN (NUEVA SECCI√ìN CON QR) -->
    <section id="donacion" class="page-view hidden bg-reropero-light-gray">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-4xl sm:text-5xl font-extrabold text-reropero-dark-green text-center mb-12">
                Cada prenda cuenta y los grandes cambios comienzan con peque√±as acciones
            </h2>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Columna de Instrucciones -->
                <div class="lg:col-span-2 bg-white p-8 rounded-xl shadow-2xl border-2 border-reropero-dark-green/30">
                    <h3 class="text-3xl font-bold text-reropero-dark-green mb-6">Prepara tus prendas</h3>
                    <p class="text-lg mb-4">
                        Para asegurar el correcto reciclaje y donaci√≥n, sigue estos sencillos pasos antes de llevar tu ropa al punto de entrega:
                    </p>
                    <ul class="space-y-3 list-disc list-inside text-lg">
                        <li class="font-semibold text-gray-900">
                            Limpieza: <span class="font-normal text-reropero-dark-green">Toda la ropa debe estar lavada y seca. ¬°No aceptamos prendas h√∫medas o con moho!</span>
                        </li>
                        <li class="font-semibold text-gray-900">
                            Separaci√≥n: <span class="font-normal text-reropero-dark-green">Separa la ropa seg√∫n su estado:
                            <ul class="ml-4 list-circle list-inside">
                                <li>Donaci√≥n: Prendas en buen estado, sin rotos ni manchas grandes que puedan ser reutilizadas.</li>
                                <li>Reciclaje: rendas muy gastadas, da√±adas o con materiales dif√≠ciles de reutilizar (por ejemplo, trapos, fibras, poli√©ster muy viejo, etc.).</li>
                            </ul>
                            </span>
                        </li>
                        <li class="font-semibold text-gray-900">
                            Empaque: <span class="font-normal text-reropero-dark-green">Lleva tus prendas en bolsas reutilizables, cajas de cart√≥n o cualquier contenedor que puedas volver a usar, y etiqueta cada uno como ‚ÄúDonaci√≥n‚Äù o ‚ÄúReciclaje‚Äù para facilitar la clasificaci√≥n, evitando el uso de bolsas pl√°sticas desechables para reducir residuos.</span>
                        </li>
                    </ul>
                    <div class="mt-8 p-4 bg-yellow-100 rounded-lg border border-yellow-300">
                        <p class="font-semibold text-yellow-800">
                            Recuerda: Cada prenda que dones o recicles ayuda a reducir residuos y a darle una segunda vida a la ropa en tu comunidad.
                        </p>
                    </div>
                </div>

                <!-- Columna de QR Code -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-2xl flex flex-col items-center justify-center text-center">
                    <h3 class="text-2xl font-bold text-reropero-dark-green mb-4">Escanea el c√≥digo QR</h3>
                    <p class="mb-4 text-lg">
                        En el punto de entrega, presiona este bot√≥n y escanea el QR para registrar tu aporte.
                    </p>
                    
                    <!-- Simulaci√≥n de QR Code (SVG est√°tico) -->
                    <div class="p-4 bg-white border-8 border-gray-100 rounded-lg shadow-xl mb-6 w-48 h-48 flex items-center justify-center">
                        <svg viewBox="0 0 100 100" class="w-40 h-40" xmlns="http://www.w3.org/2000/svg" fill="#1e5631">
                            <rect x="10" y="10" width="20" height="20"/>
                            <rect x="70" y="10" width="20" height="20"/>
                            <rect x="10" y="70" width="20" height="20"/>
                            <rect x="15" y="15" width="10" height="10" fill="#e7e8eb"/>
                            <rect x="75" y="15" width="10" height="10" fill="#e7e8eb"/>
                            <rect x="15" y="75" width="10" height="10" fill="#e7e8eb"/>
                            
                            <rect x="45" y="45" width="10" height="10"/>
                            <rect x="55" y="25" width="5" height="5"/>
                            <rect x="40" y="65" width="5" height="5"/>
                            <rect x="25" y="55" width="5" height="5"/>
                        </svg>
                    </div>

                    <button id="scan-qr-btn" onclick="simulateDonation()" class="w-full p-4 text-white bg-reropero-dark-green font-bold rounded-lg hover:bg-green-800 transition-colors transform hover:scale-105">
                        Registrar entrega 
                    </button>
                    <p class="mt-2 text-sm text-gray-600">
                        Cada registro exitoso otorga 500 puntos ü™ô
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- 4. Contenido de Mi Perfil (Fondo Gris Claro) - AHORA DIN√ÅMICO CON FIRESTORE -->
    <section id="perfil" class="page-view hidden bg-reropero-light-gray">
         <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-4xl sm:text-5xl font-extrabold text-reropero-dark-green text-center mb-12">
                ¬°Hola, Martina!
            </h2>
            
            <p id="profile-status" class="text-xl text-center mb-6 text-red-500 font-semibold hidden">
                Dale una nueva vida a tu ropa y descubre tus recompensas.
            </p>

            <div class="bg-white p-8 rounded-xl shadow-2xl border-2 border-reropero-dark-green/30" id="profile-content">
                <!-- Informaci√≥n del Usuario -->
                <div class="flex items-center mb-6 pb-6 border-b border-gray-200">
                    <div class="h-16 w-16 rounded-full bg-reropero-soft-green flex items-center justify-center text-2xl font-bold text-reropero-dark-green" id="profile-initial">M</div>
                    <div class="ml-4">
                        <h3 class="text-3xl font-bold text-gray-900" id="profile-username">@Cargando...</h3>
                        <!-- Texto en verde oscuro (heredado del body) -->
                        <p>¬°Dale una nueva vida a tu ropa!</p>
                    </div>
                </div>

                <!-- Puntos y Descuentos -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="text-2xl font-bold text-reropero-dark-green">Puntos acumulados por tus aportes</h4>
                        <p class="text-6xl font-extrabold text-green-600 my-4" id="user-points">--</p>
                        <!-- Texto en verde oscuro (heredado del body) -->
                        <p class="text-lg mb-4">
                            Sigue reciclando y desbloquea m√°s beneficios en locales asociados.
                        </p>
                        <a href="#" onclick="showSection('mapa')" class="text-reropero-dark-green font-semibold hover:underline">
                            Encuentra un punto de donaci√≥n cercano &rarr;
                        </a>
                    </div>
                    
                    <div>
                        <h4 class="text-2xl font-bold text-reropero-dark-green">Tus Descuentos Activos</h4>
                        <div class="mt-4 p-4 bg-red-100 rounded-lg border border-red-300 accessible-card">
                            <p class="font-semibold text-red-800 text-xl">10% OFF en Cafeter√≠a "El Grano"</p>
                            <p class="text-sm text-red-600 mt-1">C√≥digo: RRGRANO10 - V√°lido solo en Temuco.</p>
                        </div>
                        <div class="mt-4 p-4 bg-yellow-100 rounded-lg border border-yellow-300 accessible-card">
                            <p class="font-semibold text-yellow-800 text-xl">20% OFF en Tienda de Segunda Mano</p>
                            <p class="text-sm text-yellow-600 mt-1">Canjea en la app antes de tu compra.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 5. Contenido de Impacto (Fondo Gris Claro) - AHORA DIN√ÅMICO CON FIRESTORE -->
    <section id="impacto" class="page-view hidden bg-reropero-light-gray">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-4xl sm:text-5xl font-extrabold text-reropero-dark-green text-center mb-12">
                Nuestro impacto en el planeta üåç
            </h2>
            <!-- Texto principal ahora en verde oscuro (heredado del body) -->
            <p class="text-xl text-center max-w-2xl mx-auto mb-10">
                Gracias a las donaciones y reciclaje de toda nuestra comunidad, estamos generando un impacto real en el medio ambiente.
            </p>

            <div class="accessible-card bg-white p-8 rounded-xl shadow-2xl border-2 border-reropero-soft-green">
                <h3 class="text-2xl font-bold text-reropero-dark-green mb-6 text-center">Recursos Ahorrados</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                    <!-- Kilos Textiles (Placeholder de ejemplo: 100 kg) -->
                    <div class="p-4">
                        <span class="text-6xl font-extrabold text-reropero-dark-green block" id="user-total-kgs">100 kg</span>
                         <span class="flex items-center justify-center text-lg font-semibold text-gray-600 mt-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="svg-icon h-6 w-6 mr-1" viewBox="0 0 24 24"><path d="M20.7 7.7a.8.8 0 0 0-1.4 0l-1.3 2.1-1.3-2.1a.8.8 0 0 0-1.4 0L12 12l-3.3-5.3a.8.8 0 0 0-1.4 0L6 9.8 4.7 7.7a.8.8 0 0 0-1.4 0l-1 1.6V20h20V9.3l-1-1.6zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/></svg>Textiles reciclados
                        </span>
                    </div>
                    <!-- Litros de Agua (Placeholder de ejemplo: 150,000 L, consistente con 100 kg) -->
                    <div class="p-4">
                        <span class="text-6xl font-extrabold text-blue-600 block" id="user-total-water">150,000 L</span>
                        <span class="flex items-center justify-center text-lg font-semibold text-gray-600 mt-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="svg-icon h-6 w-6 mr-1 text-blue-600" viewBox="0 0 24 24"><path d="M12 2.69L5.64 8.78c-1.74 1.74-2.12 4.39-.7 6.22l5.7 7.42c.57.75 1.68.75 2.24 0l5.7-7.42c1.42-1.83 1.04-4.48-.7-6.22L12 2.69z"/></svg> Litros de Agua ahorrados
                        </span>
                    </div>
                    <!-- CO‚ÇÇ Evitadas (Placeholder de ejemplo: 360 kg, consistente con 100 kg) -->
                    <div class="p-4">
                        <span class="text-6xl font-extrabold text-orange-500 block" id="user-total-co2">360.0 kg</span>
                        <span class="flex items-center justify-center text-lg font-semibold text-gray-600 mt-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="svg-icon h-6 w-6 mr-1 text-orange-500" viewBox="0 0 24 24"><path d="M17.5 18a4.5 4.5 0 0 0 0-9 4.5 4.5 0 0 0-5.31-4.3c-2.45-1.12-4.9-1.3-6.94.39C3.15 6.45 2 8.35 2 10.5 2 13.59 4.41 16 7.5 16h10z"/></svg> CO‚ÇÇ Evitadas
                        </span>
                    </div>
                </div>

                <!-- Simulaci√≥n de Gr√°fico de Progreso -->
                <div class="mt-8">
                    <img src="https://placehold.co/800x200/a7d9b5/1e5631?text=Gr%C3%A1fico+de+Progreso+de+Impacto" alt="Gr√°fico de progreso de tu impacto ambiental" class="w-full rounded-lg">
                </div>
                
                <div class="mt-10 pt-6 border-t border-gray-200">
                    <!-- NUEVO P√ÅRRAFO DE CONTEXTO -->
                    <p class="mb-6 text-lg text-reropero-dark-green">
                        Seg√∫n la Asociaci√≥n Europea de Reciclaje y Reutilizaci√≥n Textil (EuRIC), reutilizar ropa tiene un impacto ambiental hasta 70 veces menor que producir prendas nuevas. Cada kilo de ropa reutilizada contribuye a reducir significativamente el consumo de agua y las emisiones de CO‚ÇÇ, ayudando a conservar recursos y a disminuir la contaminaci√≥n. Gracias a las acciones de nuestra comunidad, cada prenda que donas o reciclas genera un cambio real y positivo para el planeta.
                    </p>
                    
                    <h4 class="text-xl font-bold text-reropero-dark-green mb-4">¬øC√≥mo se calcula esto?</h4>
                    <!-- Texto en verde oscuro (heredado del body) -->
                    <p>
                        Estimamos el ahorro bas√°ndonos en estudios de ciclo de vida promedio para la industria textil. Espec√≠ficamente, cada kilo de ropa reciclada ahorra aproximadamente 1,500 litros de agua y evita 3.6 kg de emisiones de CO‚ÇÇ.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- 6. Contenido de SABER M√ÅS (LLM Powered) (Fondo Gris Claro) -->
    <section id="saber-mas" class="page-view hidden bg-reropero-light-gray">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-4xl sm:text-5xl font-extrabold text-reropero-dark-green text-center mb-12">
                El Camino Hacia la Moda Circular
            </h2>

            <!-- Pesta√±as de Navegaci√≥n -->
            <div class="flex border-b border-gray-300 mb-8">
                <button id="tab-info" onclick="showTab('info')" class="tab-button active py-2 px-4 text-lg text-gray-600 transition-colors">
                    Informaci√≥n y Noticias
                </button>
                <button id="tab-asesor" onclick="showTab('asesor')" class="tab-button py-2 px-4 text-lg text-gray-600 transition-colors">
                    Re-Asesor Textil 
                </button>
            </div>
            
            <!-- Contenido 1: Informaci√≥n y Noticias (Est√°tico) -->
            <div id="content-info" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Art√≠culo 1: Fast Fashion -->
                    <div class="accessible-card p-6 rounded-xl bg-white shadow-lg">
                        <h3 class="text-2xl font-bold text-reropero-dark-green mb-4">El Problema de la Fast Fashion</h3>
                        <p class="text-lg mb-4">
                            La moda r√°pida genera inmensas cantidades de contaminaci√≥n y desperdicio, fomentando un consumo excesivo. Entender el impacto es el primer paso.
                        </p>
                        <ul class="space-y-3 text-lg list-disc list-inside">
                            <li>Alt√≠simo consumo de agua en la producci√≥n de algod√≥n.</li>
                            <li>Micropl√°sticos que terminan en el oc√©ano a trav√©s del lavado.</li>
                            <li>Residuos textiles que saturan los vertederos.</li>
                        </ul>
                        <div class="mt-4 h-32 w-full bg-reropero-soft-green/50 rounded-lg flex items-center justify-center border border-dashed border-reropero-dark-green">
                            <span class="text-sm text-reropero-dark-green/70">Espacio para imagen: Ciclo de vida de la moda r√°pida</span>
                        </div>
                    </div>
                    
                    <!-- Art√≠culo 2: Noticia Chile -->
                    <div class="accessible-card p-6 rounded-xl bg-white shadow-lg">
                        <h3 class="text-2xl font-bold text-reropero-dark-green mb-4">Chile, un eje de residuos textiles</h3>
                        <p class="text-lg mb-4">
                            Se calcula que m√°s de 39.000 toneladas de desechos textiles son desechadas cada a√±o en el Desierto de Atacama, creando monta√±as de ropa que no son biodegradables.
                        </p>
                        <p class="text-lg mb-4">
                            Esta acumulaci√≥n es un grave problema medioambiental, liberando gases de efecto invernadero y micropl√°sticos al degradarse.
                        </p>
                        <div class="mt-4 h-32 w-full bg-reropero-soft-green/50 rounded-lg flex items-center justify-center border border-dashed border-reropero-dark-green">
                            <span class="text-sm text-reropero-dark-green/70">Espacio para imagen: Desierto de Atacama con monta√±as de ropa</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido 2: Re-Asesor Textil (LLM Powered) -->
            <div id="content-asesor" class="tab-content hidden">
                <div class="bg-white p-6 rounded-xl shadow-2xl border-2 border-reropero-dark-green/30 max-w-2xl mx-auto">
                    <h3 class="text-2xl font-bold text-reropero-dark-green mb-4 text-center">
                        Re-Asesor Textil impulsado por Gemini ‚ú®
                    </h3>
                    <p class="mb-6 text-center text-lg">
                        Cu√©ntanos sobre tu prenda y su estado, y nuestro asistente te dar√° ideas para repararla o reutilizarla, as√≠ le das m√°s vida antes de donar o reciclar.
                    </p>

                    <div class="space-y-4">
                        <label for="clothing-item" class="block font-semibold">Describe tu prenda</label>
                        <input type="text" id="clothing-item" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-reropero-dark-green focus:border-reropero-dark-green" placeholder="Ej: Pantal√≥n de mezclilla o Su√©ter de algod√≥n">
                        
                        <label for="clothing-condition" class="block font-semibold">Indica su condici√≥n </label>
                        <textarea id="clothing-condition" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-reropero-dark-green focus:border-reropero-dark-green" placeholder="Ej: Agujero peque√±o en el codo, o ya no me gusta el color."></textarea>
                    </div>

                    <button id="generate-recommendation-btn" class="w-full mt-6 p-3 text-white bg-reropero-dark-green font-bold rounded-lg hover:bg-green-800 transition-colors flex items-center justify-center" onclick="handleRecommendationClick()">
                        <svg id="llm-icon" xmlns="http://www.w3.org/2000/svg" class="svg-icon h-5 w-5 mr-2 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2z"/><path d="M9 12h.01M15 12h.01M12 9v.01M12 15v.01"/></svg>
                        Generar Recomendaci√≥n
                    </button>

                    <!-- √Årea de resultados -->
                    <div id="recommendation-results" class="mt-8 p-4 bg-reropero-light-gray rounded-lg border border-reropero-soft-green hidden">
                        <h4 class="text-xl font-bold text-reropero-dark-green mb-3">Resultado del Asesor:</h4>
                        <div id="recommendation-output" class="text-gray-700 whitespace-pre-wrap">
                            <!-- Contenido generado aqu√≠ -->
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </section>

    <!-- 7. Contenido de Ayuda (Preguntas Frecuentes) (Fondo Gris Claro) -->
    <section id="ayuda" class="page-view hidden bg-reropero-light-gray">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-4xl sm:text-5xl font-extrabold text-reropero-dark-green text-center mb-12">
                Ayuda y Soporte
            </h2>
             <!-- Texto principal ahora en verde oscuro (heredado del body) -->
            <p class="text-xl text-center max-w-2xl mx-auto mb-10">
                Aqu√≠ respondemos las dudas m√°s comunes sobre el uso de la aplicaci√≥n y el proceso de reciclaje textil.
            </p>

            <div class="space-y-4">
                <!-- Fondo de la tarjeta en blanco para contraste con fondo gris claro -->
                <div class="accessible-card p-6 rounded-xl bg-white shadow-md">
                    <h4 class="font-bold text-xl text-gray-900 mb-2">¬øQu√© tipo de prendas puedo donar/reciclar?</h4>
                    <!-- Texto en verde oscuro (heredado del body) -->
                    <p class="text-lg">Solo ropa limpia, seca y sin grandes rupturas. Las telas en mal estado o trapos deben ir a los puntos de "Reciclaje".</p>
                </div>
                 <!-- Fondo de la tarjeta en blanco para contraste con fondo gris claro -->
                <div class="accessible-card p-6 rounded-xl bg-white shadow-md">
                    <h4 class="font-bold text-xl text-gray-900 mb-2">¬øC√≥mo canjeo mis puntos?</h4>
                    <!-- Texto en verde oscuro (heredado del body) -->
                    <p class="text-lg">Debes ir a la secci√≥n "Mi Perfil" y en "Descuentos Activos" encontrar√°s los c√≥digos que puedes usar en los locales asociados, o generar un QR para canje en tienda.</p>
                </div>
                 <!-- Fondo de la tarjeta en blanco para contraste con fondo gris claro -->
                <div class="accessible-card p-6 rounded-xl bg-white shadow-md">
                    <h4 class="font-bold text-xl text-gray-900 mb-2">¬øQu√© pasa con mi ropa despu√©s?</h4>
                    <!-- Texto en verde oscuro (heredado del body) -->
                    <p class="text-lg">Depende del punto: donaci√≥n a fundaciones o venta a bajo costo; reciclaje a empresas que procesan telas para relleno o nuevos materiales, promoviendo la econom√≠a circular.</p>
                </div>
                 <!-- Fondo de la tarjeta en blanco para contraste con fondo gris claro -->
                <div class="accessible-card p-6 rounded-xl bg-white shadow-md">
                    <h4 class="font-bold text-xl text-gray-900 mb-2">¬øC√≥mo se a√±aden nuevos puntos de reciclaje a la app?</h4>
                    <!-- Texto en verde oscuro (heredado del body) -->
                    <p class="text-lg">Actualmente, solo el equipo de Re-Ropero puede verificarlos e ingresarlos. Si conoces un punto nuevo, puedes enviarnos un email.</p>
                </div>
            </div>
            <p class="mt-8 text-center text-lg text-reropero-dark-green font-semibold">
                ¬øA√∫n tienes dudas? Cont√°ctanos a support@reropero.cl
            </p>
        </div>
    </section>

    <!-- Pie de P√°gina (Fondo Verde Oscuro y Texto Gris Claro) -->
    <footer class="bg-reropero-footer-bg py-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <div class="space-y-3">
                 <!-- Texto del footer en Gris Claro -->
                <h4 class="text-xl font-bold mb-3 border-b border-white/30 pb-2 inline-block text-reropero-footer-text">Misi√≥n</h4>
                <p class="text-lg font-semibold text-reropero-footer-text">
                    Ser la plataforma l√≠der en Temuco que simplifica la transici√≥n hacia h√°bitos de consumo textil circulares y responsables.
                </p>
            </div>
            <div class="mt-6 space-y-3">
                <!-- Texto del footer en Gris Claro -->
                 <h4 class="text-xl font-bold mb-3 border-b border-white/30 pb-2 inline-block text-reropero-footer-text">Visi√≥n</h4>
                <p class="text-lg font-semibold text-reropero-footer-text">
                    Una comunidad en Temuco donde la ropa no es vista como basura, sino como un recurso valioso que regresa al ciclo de vida.
                </p>
            </div>
            <div class="mt-8 text-xs text-reropero-footer-text">
                <a href="#" class="hover:underline mx-2">T√©rminos de Servicio</a> |
                <a href="#" class="hover:underline mx-2">Pol√≠tica de Privacidad</a>
            </div>
        </div>
    </footer>
    
    <!-- Simulaci√≥n de Pantalla de Registro/Login (Modal) -->
    <div id="registro" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <button class="float-right text-gray-500 hover:text-gray-900 font-bold text-xl" onclick="document.getElementById('registro').style.display='none'">X</button>
            <h3 class="text-3xl font-bold text-reropero-dark-green mb-4 mt-4">Bienvenido a Re-Ropero</h3>
            <p class="mb-6 text-lg text-reropero-dark-green">Inicia sesi√≥n para acceder a tu perfil y recompensas.</p>
            
            <!-- Simulamos el campo de email, pero el login real se maneja con el token de Canvas -->
            <input type="email" placeholder="Correo Electr√≥nico @dominio.com" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:border-reropero-dark-green focus:ring-1 focus:ring-reropero-dark-green" disabled>
            
            <button class="w-full p-3 mb-3 text-white bg-reropero-dark-green font-bold rounded-lg hover:bg-green-800" onclick="showMessageBox('Iniciaste sesi√≥n con tu cuenta de Canvas. ¬°Bienvenido/a!', 'info'); document.getElementById('registro').style.display='none';">
                Continuar 
            </button>
            
            <div class="flex items-center my-4">
                <hr class="flex-grow border-gray-300">
                <span class="mx-2 text-sm text-gray-500">O</span>
                <hr class="flex-grow border-gray-300">
            </div>
            
            <button class="w-full p-3 mb-2 border border-gray-300 rounded-lg font-semibold flex items-center justify-center hover:bg-gray-50" disabled>
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google Logo" class="w-5 h-5 mr-2"> Continuar con Google
            </button>
            
            <button class="w-full p-3 mb-2 border border-gray-300 rounded-lg font-semibold flex items-center justify-center hover:bg-gray-50" disabled>
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Apple Logo" class="w-5 h-5 mr-2"> Continuar con Google
            </button>

            <p class="mt-4 text-xs text-gray-500">
                Al hacer clic en continuar, aceptas nuestros <a href="#" class="text-reropero-dark-green hover:underline">t√©rminos de servicio</a> y <a href="#" class="text-reropero-dark-green hover:underline">pol√≠tica de privacidad</a>.
            </p>
        </div>
    </div>

    <!-- L√≥gica de Navegaci√≥n, Firebase Authentication y Firestore -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, setDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales para servicios de Firebase
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let userProfileUnsubscribe = null; // Para detener la escucha de Firestore

        // Constantes de configuraci√≥n
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const PROFILE_PATH = (uid) => `/artifacts/${appId}/users/${uid}/profile/data`;

        // --- Funciones de Utilidad de UI ---
        
        // Funci√≥n principal para mostrar una secci√≥n y ocultar las dem√°s (adaptada para protecci√≥n)
        function showSection(sectionId) {
            // Protecci√≥n de la secci√≥n "Mi Perfil" y "Donaci√≥n" si no est√° autenticado
            if ((sectionId === 'perfil' || sectionId === 'donacion') && !userId) {
                document.getElementById('registro').style.display='flex';
                showMessageBox("Debes iniciar sesi√≥n para usar esta funci√≥n.", 'info');
                return;
            }

            // Oculta todas las secciones
            document.querySelectorAll('.page-view').forEach(section => {
                section.classList.add('hidden');
            });

            // Muestra la secci√≥n seleccionada
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.remove('hidden');
                window.scrollTo(0, 0); 

                // Actualiza el estilo del enlace activo en la navegaci√≥n
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('font-bold');
                });

                const activeLink = document.getElementById('nav-' + sectionId);
                if (activeLink) {
                    // Solo aplica 'font-bold' si no es el bot√≥n de autenticaci√≥n din√°mico
                    if (activeLink.id !== 'nav-auth') {
                         activeLink.classList.add('font-bold');
                    }
                }
            }
        }
        
        // Funci√≥n para cambiar las pesta√±as dentro de "Saber M√°s"
        function showTab(tabId) {
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            // Remover 'active' de todos los botones
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Mostrar el contenido y activar el bot√≥n
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // Funci√≥n de utilidad para caja de mensajes personalizada
        function showMessageBox(message, type) {
            const msgBox = document.getElementById('message-box');
            const msgText = document.getElementById('message-text');
            
            if (msgBox && msgText) {
                msgText.textContent = message;
                msgBox.className = 'fixed top-20 right-4 p-4 rounded-lg shadow-xl z-50 transition-transform transform';
                
                if (type === 'error') {
                    msgBox.classList.add('bg-red-500', 'text-white');
                } else if (type === 'info') {
                    msgBox.classList.add('bg-blue-500', 'text-white');
                } else if (type === 'success') {
                    msgBox.classList.add('bg-green-500', 'text-white');
                }
                
                msgBox.classList.remove('translate-x-full'); // Desliza hacia adentro
                setTimeout(() => {
                    msgBox.classList.add('translate-x-full'); // Desliza hacia afuera despu√©s de 4 segundos
                }, 4000);
            }
        }

        // Hacemos las funciones globales para que puedan ser llamadas desde los atributos 'onclick' del HTML
        window.showSection = showSection;
        window.showMessageBox = showMessageBox;
        window.showTab = showTab;


        // --- L√≥gica de Firebase y Auth ---
        
        if (Object.keys(firebaseConfig).length > 0) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug'); // Habilitar logs de debug
            } catch (e) {
                console.error("Error al inicializar Firebase:", e);
            }
            
            // 1. Manejar Autenticaci√≥n Inicial (con token de Canvas o an√≥nima)
            const initialAuth = async () => {
                if (!auth) return;
                try {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (token) {
                        await signInWithCustomToken(auth, token);
                        console.log("Sesi√≥n iniciada con token personalizado.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Sesi√≥n iniciada an√≥nimamente.");
                    }
                } catch (error) {
                    console.error("Error durante la autenticaci√≥n inicial:", error);
                }
            };

            // 2. Listener del Estado de Autenticaci√≥n
            onAuthStateChanged(auth, (user) => {
                isAuthReady = true;
                const prevUserId = userId;
                userId = user ? user.uid : null;
                updateNavUI(user);
                
                if (userId && userId !== prevUserId) {
                    // Si un usuario nuevo se autentica, empezamos a escuchar su perfil
                    listenToUserProfile(userId);
                } else if (!userId) {
                    // Si el usuario cierra sesi√≥n, detenemos la escucha y limpiamos la UI
                    if (userProfileUnsubscribe) {
                        userProfileUnsubscribe();
                        userProfileUnsubscribe = null;
                    }
                    updateProfileUI({ points: 0, total_kgs: 0 });
                }
                
                // Asegura que la secci√≥n de inicio se muestre al cargar o cambiar estado
                showSection('proposito');
            });

            // 3. Iniciar el proceso de autenticaci√≥n
            initialAuth();
        } else {
            console.error("La configuraci√≥n de Firebase est√° faltando o es inv√°lida.");
            isAuthReady = true;
            updateNavUI(null); // Inicializar UI sin Firebase
        }

        // Funci√≥n para actualizar la barra de navegaci√≥n y los elementos de la interfaz
        function updateNavUI(user) {
            const authLink = document.getElementById('nav-auth');
            const profileLink = document.getElementById('nav-perfil');
            const donacionLink = document.getElementById('nav-donacion');
            const profileLinkContainer = profileLink.parentNode; 
            const userIdDisplay = document.getElementById('user-id-display');

            if (user) {
                // Estado: Loggeado
                profileLink.classList.remove('hidden');
                
                authLink.textContent = 'Cerrar Sesi√≥n';
                authLink.onclick = handleSignOut;
                authLink.classList.remove('bg-reropero-dark-green', 'text-white', 'hover:bg-green-700');
                authLink.classList.add('text-reropero-dark-green', 'hover:text-green-700', 'border', 'border-reropero-dark-green');
                
                // Mostrar ID de usuario (MANDATORIO)
                if (userIdDisplay) {
                    userIdDisplay.textContent = `ID: ${user.uid}`;
                    userIdDisplay.classList.remove('hidden');
                }

                // Inicializar el perfil si no existe (solo la primera vez)
                initializeUserProfile(user.uid);

            } else {
                // Estado: Desconectado
                profileLink.classList.add('hidden');
                
                authLink.textContent = 'Iniciar Sesi√≥n';
                authLink.onclick = () => document.getElementById('registro').style.display='flex';
                authLink.classList.add('bg-reropero-dark-green', 'text-white', 'hover:bg-green-700');
                authLink.classList.remove('text-reropero-dark-green', 'hover:text-green-700', 'border');
                
                // Ocultar ID de usuario
                if (userIdDisplay) {
                    userIdDisplay.classList.add('hidden');
                }
            }
        }

        // Funci√≥n para manejar el cierre de sesi√≥n de Firebase
        async function handleSignOut(event) {
            event.preventDefault();
            if (!auth) {
                console.error("Auth no inicializado.");
                return;
            }
            try {
                // Detener escucha de perfil antes de cerrar sesi√≥n
                if (userProfileUnsubscribe) {
                    userProfileUnsubscribe();
                    userProfileUnsubscribe = null;
                }
                await signOut(auth);
                console.log("Usuario cerr√≥ sesi√≥n exitosamente.");
                showMessageBox("¬°Sesi√≥n cerrada! Vuelve pronto.", 'info');
                // Redirecci√≥n a 'proposito' manejada por onAuthStateChanged
            } catch (error) {
                console.error("Error al cerrar sesi√≥n:", error);
                showMessageBox("Error al cerrar sesi√≥n. Int√©ntalo de nuevo.", 'error');
            }
        }
        
        // --- L√≥gica de Firestore (Perfil de Usuario) ---
        
        // Inicializar el perfil de usuario con valores por defecto si no existe
        async function initializeUserProfile(uid) {
            if (!db) return;
            const profileRef = doc(db, PROFILE_PATH(uid));
            try {
                await setDoc(profileRef, { 
                    points: 0, 
                    total_kgs: 0,
                    initializedAt: new Date().getTime(),
                    username: `@user_${uid.substring(0, 8)}`
                }, { merge: true });
            } catch (error) {
                console.error("Error al inicializar el perfil:", error);
            }
        }

        // Escuchar el perfil del usuario en tiempo real
        function listenToUserProfile(uid) {
            if (userProfileUnsubscribe) {
                userProfileUnsubscribe(); // Detener escucha anterior
            }
            const profileRef = doc(db, PROFILE_PATH(uid));
            userProfileUnsubscribe = onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    updateProfileUI(data);
                } else {
                    // Documento no existe, inicializar con 0
                    updateProfileUI({ points: 0, total_kgs: 0 });
                    initializeUserProfile(uid); 
                }
            }, (error) => {
                console.error("Error en onSnapshot de perfil:", error);
                showMessageBox("Error al cargar tus datos. Revisa la consola.", 'error');
            });
        }

        // Actualizar la interfaz con los datos del perfil
        function updateProfileUI(data) {
            const points = data.points || 0;
            const kgs = data.total_kgs || 0;
            const username = data.username || `@user_${userId ? userId.substring(0, 8) : 'anon'}`;
            
            // Perfil
            document.getElementById('user-points').textContent = points.toLocaleString('es-CL');
            document.getElementById('profile-username').textContent = username;
            document.getElementById('profile-initial').textContent = username.charAt(1).toUpperCase(); // Primera letra del username (despu√©s del @)

            // Impacto
            const totalLitros = (kgs * 1500).toLocaleString('es-CL', { maximumFractionDigits: 0 });
            const totalCO2 = (kgs * 3.6).toFixed(1);

            document.getElementById('user-total-kgs').textContent = `${kgs.toFixed(1)} kg`;
            document.getElementById('user-total-water').textContent = totalLitros;
            document.getElementById('user-total-co2').textContent = `${totalCO2} kg`;
        }

        // Simular el registro de una donaci√≥n con el bot√≥n QR
        window.simulateDonation = async function() {
            if (!userId) {
                showMessageBox("Debes iniciar sesi√≥n para registrar una donaci√≥n.", 'error');
                document.getElementById('registro').style.display='flex';
                return;
            }

            if (!db) return;

            const POINTS_REWARD = 500;
            const KGS_REWARD = 5.0; // Simular 5kg por entrega
            const profileRef = doc(db, PROFILE_PATH(userId));
            const button = document.getElementById('scan-qr-btn');

            button.disabled = true;
            button.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Registrando...';

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(profileRef);

                    // Obtener valores actuales (o 0 si es la primera vez)
                    const currentPoints = docSnap.data()?.points || 0;
                    const currentKgs = docSnap.data()?.total_kgs || 0;

                    // Calcular nuevos valores
                    const newPoints = currentPoints + POINTS_REWARD;
                    const newKgs = currentKgs + KGS_REWARD;

                    // Actualizar el documento
                    transaction.set(profileRef, {
                        points: newPoints,
                        total_kgs: newKgs,
                        last_donation: new Date().getTime(),
                    }, { merge: true });
                });
                
                showMessageBox(`¬°Donaci√≥n registrada! Ganaste ${POINTS_REWARD} puntos y sumaste ${KGS_REWARD} kg.`, 'success');
                
            } catch (e) {
                console.error("Error al registrar la donaci√≥n (Transacci√≥n fallida):", e);
                showMessageBox("Error al registrar. Int√©ntalo de nuevo.", 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = 'Registrar Entrega y ¬°Ganar Puntos! ü™ô';
            }
        }
        
        // --- L√≥gica de la API de Gemini (Re-Asesor Textil) ---
        
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;
        const API_KEY = ""; // Canvas runtime provides this

        const systemPrompt = "Act√∫a como un asesor de sostenibilidad textil experto, amigable y muy pr√°ctico. Tu objetivo es ayudar a las personas a reducir los residuos y reutilizar la ropa. La respuesta DEBE estar en espa√±ol y seguir estrictamente este formato con encabezados y nueva l√≠nea: \n**1. Recomendaci√≥n de Transformaci√≥n/Reparaci√≥n:**\n[Respuesta concisa sobre c√≥mo arreglar o re-dise√±ar la prenda.]\n\n**2. Opci√≥n de Disposici√≥n √ìptima:**\n[Indica solo una de estas opciones: Donaci√≥n, Reciclaje (para trapos/fibras), o Descarte (solo si es peligroso/contaminado). Justifica brevemente.]";
        
        // Implementaci√≥n de Backoff Exponencial para la API de Gemini
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                         throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // Wait before retrying (exponential backoff)
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function generateRecommendation(clothingItem, condition) {
            const userQuery = `Tengo un(a) "${clothingItem}" en la siguiente condici√≥n: "${condition}". ¬øQu√© me recomiendas hacer?`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };
            
            try {
                const response = await fetchWithBackoff(API_URL + API_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    return text;
                } else {
                    console.error("Gemini API: No se pudo obtener la respuesta de texto.", result);
                    return "Lo sentimos, el Re-Asesor Textil no pudo generar una recomendaci√≥n. Intenta con una descripci√≥n m√°s simple.";
                }

            } catch (error) {
                console.error("Error al llamar a la API de Gemini:", error);
                return "Hubo un error de conexi√≥n con el Re-Asesor Textil. Por favor, int√©ntalo m√°s tarde.";
            }
        }
        
        // Manejador de eventos para el bot√≥n LLM
        window.handleRecommendationClick = async function() {
            const itemInput = document.getElementById('clothing-item');
            const conditionInput = document.getElementById('clothing-condition');
            const resultsDiv = document.getElementById('recommendation-results');
            const outputDiv = document.getElementById('recommendation-output');
            const button = document.getElementById('generate-recommendation-btn');
            const item = itemInput.value.trim();
            const condition = conditionInput.value.trim();

            if (!item || !condition) {
                showMessageBox("Por favor, describe la prenda y su condici√≥n.", 'error');
                return;
            }
            
            // Mostrar estado de carga
            button.disabled = true;
            button.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Generando...';
            resultsDiv.classList.remove('hidden');
            outputDiv.textContent = "Consultando al asesor...";

            const recommendation = await generateRecommendation(item, condition);

            // Restaurar estado
            button.disabled = false;
            button.innerHTML = '<svg id="llm-icon" xmlns="http://www.w3.org/2000/svg" class="svg-icon h-5 w-5 mr-2 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2z"/><path d="M9 12h.01M15 12h.01M12 9v.01M12 15v.01"/></svg>Generar Recomendaci√≥n';
            
            // Mostrar resultado final
            outputDiv.textContent = recommendation;
            showMessageBox("¬°Recomendaci√≥n generada con √©xito!", 'success');
        }
    </script>
</body>
</html>
